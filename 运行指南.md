# TimeDP 训练运行指南

## 前置准备

### 1. 检查环境变量

首先确保设置了 `DATA_ROOT` 环境变量：

**Windows PowerShell:**
```powershell
# 检查是否已设置
echo $env:DATA_ROOT

# 如果未设置，设置它（替换为你的实际数据路径）
$env:DATA_ROOT = "C:\path\to\your\data"
```

**Windows CMD:**
```cmd
# 检查
echo %DATA_ROOT%

# 设置
set DATA_ROOT=C:\path\to\your\data
```

**永久设置（推荐）**：
1. 右键"此电脑" → 属性
2. 高级系统设置 → 环境变量
3. 新建系统变量：`DATA_ROOT` = `C:\path\to\your\data`

### 2. 检查数据文件

确保数据文件存在，格式为：
```
{DATA_ROOT}/
  ├── solar_168_train.npy
  ├── electricity_168_train.npy
  ├── traffic_168_train.npy
  └── ... (其他数据集)
```

## 运行训练

### 方式1：基础训练（不使用GNN）

```powershell
# 激活conda环境
conda activate timedp

# 运行训练
python main_train.py `
  --base configs/multi_domain_timedp.yaml `
  --gpus 0, `
  --logdir ./logs/ `
  -sl 168 `
  -up `
  -nl 16 `
  --batch_size 128 `
  -lr 0.0001 `
  -s 0
```

**参数说明**：
- `--base`: 配置文件路径
- `--gpus 0,`: 使用GPU 0（注意逗号）
- `--logdir`: 日志保存目录
- `-sl 168`: 序列长度168
- `-up`: 使用PAM（原型注意力机制）
- `-nl 16`: 原型数量16
- `--batch_size 128`: 批次大小128
- `-lr 0.0001`: 学习率0.0001
- `-s 0`: 随机种子0

### 方式2：启用GNN（自动推断变量数）

```powershell
conda activate timedp

python main_train.py `
  --base configs/multi_domain_timedp.yaml `
  --gpus 0, `
  --logdir ./logs/ `
  -sl 168 `
  -up `
  -nl 16 `
  --batch_size 128 `
  -lr 0.0001 `
  -s 0 `
  --use_gnn `
  --gnn_type simple_gcn `
  --gnn_layers 2
```

**新增参数**：
- `--use_gnn`: 启用GNN多变量交互
- `--gnn_type simple_gcn`: 使用简单GCN（无需额外依赖）
- `--gnn_layers 2`: GNN层数

**注意**：系统会自动从数据推断变量数，单变量数据集会自动跳过GNN。

### 方式3：启用GNN（手动指定变量数）

如果所有数据集变量数相同，可以手动指定：

```powershell
conda activate timedp

python main_train.py `
  --base configs/multi_domain_timedp.yaml `
  --gpus 0, `
  --logdir ./logs/ `
  -sl 168 `
  -up `
  -nl 16 `
  --batch_size 125 `
  -lr 0.0001 `
  -s 0 `
  --use_gnn `
  --num_variables 5 `
  --gnn_type simple_gcn `
  --gnn_layers 2
```

**注意**：`--batch_size 125` 必须能被 `--num_variables 5` 整除（125 ÷ 5 = 25 ✅）

### 方式4：从检查点恢复训练

```powershell
conda activate timedp

python main_train.py `
  --base configs/multi_domain_timedp.yaml `
  --gpus 0, `
  --logdir ./logs/ `
  -sl 168 `
  -up `
  -nl 16 `
  --batch_size 128 `
  -lr 0.0001 `
  -s 0 `
  --resume
```

## 完整命令示例

### 示例1：标准训练（推荐）

```powershell
conda activate timedp
python main_train.py --base configs/multi_domain_timedp.yaml --gpus 0, --logdir ./logs/ -sl 168 -up -nl 16 --batch_size 128 -lr 0.0001 -s 0
```

### 示例2：GNN增强训练

```powershell
conda activate timedp
python main_train.py --base configs/multi_domain_timedp.yaml --gpus 0, --logdir ./logs/ -sl 168 -up -nl 16 --batch_size 128 -lr 0.0001 -s 0 --use_gnn --gnn_type simple_gcn
```

### 示例3：调试模式（快速测试）

```powershell
conda activate timedp
python main_train.py --base configs/multi_domain_timedp.yaml --gpus 0, --logdir ./logs/ -sl 168 -up -nl 16 --batch_size 128 -lr 0.0001 -s 0 --debug
```

调试模式只训练10步，用于快速验证代码是否正常。

## 检查训练状态

### 查看日志

训练日志保存在：
```
./logs/multi_domain_timedp/multi_domain_timedp_168_nl_16_lr1.0e-04_bs128_pam_seed0/
```

### 查看TensorBoard

```powershell
conda activate timedp
tensorboard --logdir ./logs/
```

然后在浏览器打开 `http://localhost:6006`

## 常见问题

### 1. `KeyError: 'DATA_ROOT'`

**解决**：设置环境变量
```powershell
$env:DATA_ROOT = "C:\path\to\your\data"
```

### 2. `FileNotFoundError: 找不到数据文件`

**解决**：检查数据路径和文件名格式
- 确保文件名为：`{dataset_name}_{seq_len}_train.npy`
- 例如：`solar_168_train.npy`

### 3. `batch_size must be divisible by num_variables`

**解决**：调整batch_size使其能被变量数整除
- 例如：`num_variables=5`，使用 `batch_size=125`（125 ÷ 5 = 25）

### 4. GPU内存不足

**解决**：减小batch_size
```powershell
--batch_size 64  # 从128减小到64
```

## 训练参数调优建议

### 学习率
- 默认：`0.0001`
- 可以尝试：`0.0005`, `0.00005`

### 批次大小
- 默认：`128`
- 根据GPU内存调整：`64`, `256`

### 序列长度
- 默认：`168`
- 可以尝试：`96`, `336`

### 原型数量
- 默认：`16`
- 可以尝试：`8`, `32`

## 监控训练

训练过程中会输出：
- 当前epoch和step
- 损失值
- 学习率
- GPU使用情况

按 `Ctrl+C` 可以安全中断训练（会保存检查点）。

